From 9cfeea9155cca2febc2ab57daa57b7e4f22bfb2d Mon Sep 17 00:00:00 2001
From: Simon Fels <simon.fels@canonical.com>
Date: Fri, 24 Mar 2017 17:54:48 +0100
Subject: [PATCH 1/6] packaging: use templates for relevant systemd units

To make packaging across different distributionis a bit easier we
now use templates for some of our systemd units and replace things
which are in a different location with sed at build time.
---
 .gitignore                               |  5 +++++
 data/systemd/snapd.autoimport.service    | 10 ----------
 data/systemd/snapd.autoimport.service.in | 10 ++++++++++
 data/systemd/snapd.refresh.service       | 11 -----------
 data/systemd/snapd.refresh.service.in    | 11 +++++++++++
 data/systemd/snapd.service               | 11 -----------
 data/systemd/snapd.service.in            | 11 +++++++++++
 7 files changed, 37 insertions(+), 32 deletions(-)
 delete mode 100644 data/systemd/snapd.autoimport.service
 create mode 100644 data/systemd/snapd.autoimport.service.in
 delete mode 100644 data/systemd/snapd.refresh.service
 create mode 100644 data/systemd/snapd.refresh.service.in
 delete mode 100644 data/systemd/snapd.service
 create mode 100644 data/systemd/snapd.service.in

diff --git a/.gitignore b/.gitignore
index 5c55fd5..5b6919f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -30,6 +30,11 @@ cmd/system-shutdown/unit-tests
 # manual pages
 cmd/*/*.[1-9]
 
+# auto-generated systemd units
+data/systemd/snapd.autoimport.service
+data/systemd/snapd.refresh.service
+data/systemd/snapd.service
+
 # test-driver
 *.log
 *.trs
diff --git a/data/systemd/snapd.autoimport.service b/data/systemd/snapd.autoimport.service
deleted file mode 100644
index 2c75f15..0000000
--- a/data/systemd/snapd.autoimport.service
+++ /dev/null
@@ -1,10 +0,0 @@
-[Unit]
-Description=Auto import assertions from block devices
-After=snapd.service snapd.socket
-
-[Service]
-Type=oneshot
-ExecStart=/usr/bin/snap auto-import
-
-[Install]
-WantedBy=multi-user.target
diff --git a/data/systemd/snapd.autoimport.service.in b/data/systemd/snapd.autoimport.service.in
new file mode 100644
index 0000000..04b9a7e
--- /dev/null
+++ b/data/systemd/snapd.autoimport.service.in
@@ -0,0 +1,10 @@
+[Unit]
+Description=Auto import assertions from block devices
+After=snapd.service snapd.socket
+
+[Service]
+Type=oneshot
+ExecStart=@bindir@/snap auto-import
+
+[Install]
+WantedBy=multi-user.target
diff --git a/data/systemd/snapd.refresh.service b/data/systemd/snapd.refresh.service
deleted file mode 100644
index 893217f..0000000
--- a/data/systemd/snapd.refresh.service
+++ /dev/null
@@ -1,11 +0,0 @@
-[Unit]
-Description=Automatically refresh installed snaps
-After=network-online.target snapd.socket
-Requires=snapd.socket
-ConditionPathExistsGlob=/snap/*/current
-Documentation=man:snap(1)
-
-[Service]
-Type=oneshot
-ExecStart=/usr/bin/snap refresh
-Environment=SNAP_REFRESH_FROM_EMERGENCY_TIMER=1
diff --git a/data/systemd/snapd.refresh.service.in b/data/systemd/snapd.refresh.service.in
new file mode 100644
index 0000000..d5cd14b
--- /dev/null
+++ b/data/systemd/snapd.refresh.service.in
@@ -0,0 +1,11 @@
+[Unit]
+Description=Automatically refresh installed snaps
+After=network-online.target snapd.socket
+Requires=snapd.socket
+ConditionPathExistsGlob=@SNAP_MOUNTDIR@/*/current
+Documentation=man:snap(1)
+
+[Service]
+Type=oneshot
+ExecStart=@bindir@/snap refresh
+Environment=SNAP_REFRESH_FROM_EMERGENCY_TIMER=1
diff --git a/data/systemd/snapd.service b/data/systemd/snapd.service
deleted file mode 100644
index 0863225..0000000
--- a/data/systemd/snapd.service
+++ /dev/null
@@ -1,11 +0,0 @@
-[Unit]
-Description=Snappy daemon
-Requires=snapd.socket
-
-[Service]
-ExecStart=/usr/lib/snapd/snapd
-EnvironmentFile=/etc/environment
-Restart=always
-
-[Install]
-WantedBy=multi-user.target
diff --git a/data/systemd/snapd.service.in b/data/systemd/snapd.service.in
new file mode 100644
index 0000000..009e62e
--- /dev/null
+++ b/data/systemd/snapd.service.in
@@ -0,0 +1,11 @@
+[Unit]
+Description=Snappy daemon
+Requires=snapd.socket
+
+[Service]
+ExecStart=@libexecdir@/snapd/snapd
+EnvironmentFile=@SNAPD_ENVIRONMENT_FILE@
+Restart=always
+
+[Install]
+WantedBy=multi-user.target

From 13f65b06b339f80c4dca9bd716c53908b00947b3 Mon Sep 17 00:00:00 2001
From: Simon Fels <simon.fels@canonical.com>
Date: Tue, 28 Mar 2017 09:06:48 +0200
Subject: [PATCH 2/6] data/systemd: move systemd unit
 generation into separate makefile

---
 data/systemd/Makefile        | 15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)
 create mode 100644 data/systemd/Makefile

diff --git a/data/systemd/Makefile b/data/systemd/Makefile
new file mode 100644
index 0000000..d40b218
--- /dev/null
+++ b/data/systemd/Makefile
@@ -0,0 +1,15 @@
+SNAPD_ENVIRONMENT_FILE := /etc/environment
+SNAP_MOUNTDIR := /snap
+BINDIR := /usr/bin
+LIBEXECDIR := /usr/lib
+
+all:
+	# Generate the real systemd units out of the available templates
+	cat snapd.service.in | \
+		sed s:@libexecdir@:${LIBEXECDIR}:g | \
+		sed s:@SNAPD_ENVIRONMENT_FILE@:${SNAPD_ENVIRONMENT_FILE}:g > snapd.service
+	cat 	snapd.refresh.service.in | \
+		sed s:@bindir@:${BINDIR}:g | \
+		sed s:@SNAP_MOUNTDIR@:${SNAP_MOUNTDIR}:g > snapd.refresh.service
+	cat snapd.autoimport.service.in | \
+		sed s:@bindir@:${BINDIR}:g > snapd.autoimport.service

From 9d871a1e0dd16979367c2dcf9416e122dadd013e Mon Sep 17 00:00:00 2001
From: Simon Fels <simon.fels@canonical.com>
Date: Tue, 28 Mar 2017 14:22:06 +0200
Subject: [PATCH 3/6] data/systemd: make environment file non-mandatory

---
 data/systemd/snapd.service.in | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/data/systemd/snapd.service.in b/data/systemd/snapd.service.in
index 009e62e..567fe87 100644
--- a/data/systemd/snapd.service.in
+++ b/data/systemd/snapd.service.in
@@ -4,7 +4,7 @@ Requires=snapd.socket
 
 [Service]
 ExecStart=@libexecdir@/snapd/snapd
-EnvironmentFile=@SNAPD_ENVIRONMENT_FILE@
+EnvironmentFile=-@SNAPD_ENVIRONMENT_FILE@
 Restart=always
 
 [Install]

From 3e2a80a6c5649a2d43a89882cfe67bafc3454c64 Mon Sep 17 00:00:00 2001
From: Simon Fels <simon.fels@canonical.com>
Date: Tue, 28 Mar 2017 14:27:21 +0200
Subject: [PATCH 4/6] data/systemd: add install rule for all
 systemd units

---
 data/systemd/Makefile        | 11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/data/systemd/Makefile b/data/systemd/Makefile
index d40b218..8516d81 100644
--- a/data/systemd/Makefile
+++ b/data/systemd/Makefile
@@ -2,6 +2,7 @@ SNAPD_ENVIRONMENT_FILE := /etc/environment
 SNAP_MOUNTDIR := /snap
 BINDIR := /usr/bin
 LIBEXECDIR := /usr/lib
+SYSTEMDSYSTEMUNITDIR := /lib/systemd/system
 
 all:
 	# Generate the real systemd units out of the available templates
@@ -13,3 +14,13 @@ all:
 		sed s:@SNAP_MOUNTDIR@:${SNAP_MOUNTDIR}:g > snapd.refresh.service
 	cat snapd.autoimport.service.in | \
 		sed s:@bindir@:${BINDIR}:g > snapd.autoimport.service
+
+install:
+	install -d ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 snapd.refresh.timer ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 snapd.refresh.service ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 snapd.autoimport.service ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 *.socket ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 snapd.service ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+	install --mode=0644 snapd.system-shutdown.service ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
+
 

From f63c7bbbd2d87eac2a01ca2a7e96ec41f12d5dbf Mon Sep 17 00:00:00 2001
From: Simon Fels <simon.fels@canonical.com>
Date: Wed, 29 Mar 2017 13:13:21 +0200
Subject: [PATCH 6/6] data/systemd: add template for
 snapd.system-shutdown.service too

---
 .gitignore                                    |  1 +
 data/systemd/Makefile                         |  2 ++
 data/systemd/snapd.system-shutdown.service    | 15 ---------------
 data/systemd/snapd.system-shutdown.service.in | 15 +++++++++++++++
 4 files changed, 18 insertions(+), 15 deletions(-)
 delete mode 100644 data/systemd/snapd.system-shutdown.service
 create mode 100644 data/systemd/snapd.system-shutdown.service.in

diff --git a/.gitignore b/.gitignore
index 5b6919f..6749a86 100644
--- a/.gitignore
+++ b/.gitignore
@@ -34,6 +34,7 @@ cmd/*/*.[1-9]
 data/systemd/snapd.autoimport.service
 data/systemd/snapd.refresh.service
 data/systemd/snapd.service
+data/systemd/snapd.system-shutdown.service
 
 # test-driver
 *.log
diff --git a/data/systemd/Makefile b/data/systemd/Makefile
index 8516d81..325b7d0 100644
--- a/data/systemd/Makefile
+++ b/data/systemd/Makefile
@@ -14,6 +14,8 @@ all:
 		sed s:@SNAP_MOUNTDIR@:${SNAP_MOUNTDIR}:g > snapd.refresh.service
 	cat snapd.autoimport.service.in | \
 		sed s:@bindir@:${BINDIR}:g > snapd.autoimport.service
+	cat snapd.system-shutdown.service.in | \
+		sed s:@libexecdir@:${LIBEXECDIR}:g > snapd.system-shutdown.service
 
 install:
 	install -d ${DESTDIR}/${SYSTEMDSYSTEMUNITDIR}
diff --git a/data/systemd/snapd.system-shutdown.service b/data/systemd/snapd.system-shutdown.service
deleted file mode 100644
index add7113..0000000
--- a/data/systemd/snapd.system-shutdown.service
+++ /dev/null
@@ -1,15 +0,0 @@
-[Unit]
-Description=Ubuntu core (all-snaps) system shutdown helper setup service
-Before=umount.target
-DefaultDependencies=false
-# don't run on classic
-ConditionKernelCommandLine=snap_core
-# don't run if system-shutdown isn't there
-ConditionPathExists=/usr/lib/snapd/system-shutdown
-
-[Service]
-Type=oneshot
-ExecStart=/bin/sh -euc 'mount /run -o remount,exec; mkdir -p /run/initramfs; cp /usr/lib/snapd/system-shutdown /run/initramfs/shutdown'
-
-[Install]
-WantedBy=final.target
diff --git a/data/systemd/snapd.system-shutdown.service.in b/data/systemd/snapd.system-shutdown.service.in
new file mode 100644
index 0000000..1d9249c
--- /dev/null
+++ b/data/systemd/snapd.system-shutdown.service.in
@@ -0,0 +1,15 @@
+[Unit]
+Description=Ubuntu core (all-snaps) system shutdown helper setup service
+Before=umount.target
+DefaultDependencies=false
+# don't run on classic
+ConditionKernelCommandLine=snap_core
+# don't run if system-shutdown isn't there
+ConditionPathExists=@libexecdir@/snapd/system-shutdown
+
+[Service]
+Type=oneshot
+ExecStart=/bin/sh -euc 'mount /run -o remount,exec; mkdir -p /run/initramfs; cp @libexecdir@/snapd/system-shutdown /run/initramfs/shutdown'
+
+[Install]
+WantedBy=final.target
